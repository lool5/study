{% extends 'tracker/base.html' %}

{% block title %}لوحة الإحصائيات{% endblock %}

{% block content %}
<style>
body {
    background: linear-gradient(135deg, #1e3a8a, #6b7280);
    font-family: 'Tajawal', sans-serif;
    overflow-x: hidden;
    position: relative;
}
.glass-card {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.glass-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}
.chart-container {
    width: 100%;
    max-width: 1200px; /* زيادة الحجم الأقصى */
    height: 600px; /* زيادة ارتفاع الرسم البياني */
    margin: 0 auto;
    padding: 40px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);
}
.progress-bar {
    transition: width 1s ease-in-out;
    font-size: 1.2rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
}
.alert-warning {
    background: rgba(255, 193, 7, 0.2);
    border: 1px solid #ffc107;
    color: #fff;
}
h1, h3 {
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}
.particles {
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    pointer-events: none;
    z-index: -1;
}
</style>

<div class="container-fluid py-5 position-relative">
    <!-- خلفية الجسيمات (Particles) -->
    <canvas class="particles" id="particleCanvas"></canvas>

    <h1 class="text-center mb-5 text-white fw-bold">📊 لوحة الإحصائيات السنوية</h1>

    <!-- تنبيه إذا كان التقدم ضعيف -->
    {% if alert_message %}
    <div class="alert alert-warning alert-dismissible fade show text-center mx-auto" style="max-width: 600px;">
        {{ alert_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- السيرش -->
    <div class="row mb-5">
        <div class="col-md-8 mx-auto">
            <div class="card glass-card p-4">
                <h3 class="text-center mb-4 text-white"><i class="fas fa-search"></i> بحث في المحتوى</h3>
                <form method="GET" class="d-flex">
                    <input type="text" name="search" value="{{ search_query|default:'' }}" class="form-control me-2" placeholder="ابحث في الأكواد، الصور، المذكرات..." required>
                    <select name="type" class="form-select me-2" style="width: auto;">
                        <option value="">الكل</option>
                        <option value="day" {% if type_filter == 'day' %}selected{% endif %}>يوم</option>
                        <option value="code" {% if type_filter == 'code' %}selected{% endif %}>كود</option>
                        <option value="image" {% if type_filter == 'image' %}selected{% endif %}>صورة</option>
                        <option value="note" {% if type_filter == 'note' %}selected{% endif %}>مذكرة</option>
                        <option value="english_note" {% if type_filter == 'english_note' %}selected{% endif %}>ملاحظة إنجليزية</option>
                    </select>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i></button>
                </form>
                {% if items %}
                <div class="row mt-4 g-3">
                    {% for item in items %}
                    <div class="col-md-4">
                        <div class="card glass-card p-3">
                            <h6 class="text-white">{{ item.title }}</h6>
                            <p class="text-white small">نوع: {{ item.item_type }} | {{ item.day.date|date:"d/m/Y" }}</p>
                            {% if item.item_type == 'صورة' %}
                            <img src="{{ item.file.url }}" class="img-fluid mb-2" style="max-height: 150px; cursor: pointer;" onclick="openModal('{{ item.file.url }}', '{{ item.title|escapejs }}', 'image')">
                            <button class="btn btn-primary btn-sm" onclick="openModal('{{ item.file.url }}', '{{ item.title|escapejs }}', 'image')">عرض التفاصيل</button>
                            {% else %}
                            <p class="text-white">{{ item.content|truncatewords:10 }}</p>
                            <button class="btn btn-primary btn-sm" onclick="openModal('{{ item.content|escapejs }}', '{{ item.title|escapejs }}', '{{ item.item_type|lower }}')">عرض التفاصيل</button>
                            {% endif %}
                            <a href="{% url 'day_detail' item.day.id %}" class="btn btn-secondary btn-sm mt-2">تفاصيل اليوم</a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-center text-white mt-4">لا توجد نتائج</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- رسم بياني -->
    <div class="card glass-card p-4 mb-5">
        <h3 class="text-center mb-4 text-white">📈 تقدم الساعات، النجوم، والأيام حسب الشهر</h3>
        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>
    </div>

    <!-- الأيام الضعيفة -->
    {% if weak_days %}
    <div class="card glass-card p-4 mb-5">
        <h3 class="text-center mb-4 text-white">⚠️ الأيام بأقل من 3 ساعات</h3>
        <div class="row g-3">
            {% for day in weak_days %}
            <div class="col-md-3">
                <div class="card glass-card p-3 text-center">
                    <h6 class="text-white">{{ day.date|date:"d/m/Y" }}</h6>
                    <p class="text-white small">إجمالي: {{ day.total_hours|floatformat:0 }} ساعة</p>
                    <a href="{% url 'day_detail' day.id %}" class="btn btn-warning btn-sm">تفاصيل</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- كروت الإحصائيات -->
    <div class="row mb-5 g-4">
        <div class="col-md-4">
            <div class="card glass-card p-4 text-center">
                <i class="fas fa-clock fa-3x mb-3 text-primary"></i>
                <h3 class="text-white">ساعات الدراسة</h3>
                <h2 class="text-white fw-bold">{{ studied_hours|floatformat:0 }}</h2>
                <p class="text-white">من {{ total_possible_hours }} ساعة</p>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-primary" style="width: {{ hours_progress }}%;">
                        {{ hours_progress|floatformat:1 }}%
                    </div>
                </div>
                <small class="text-white mt-2">متبقي: {{ remaining_hours|floatformat:0 }} ساعة</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card glass-card p-4 text-center">
                <i class="fas fa-star fa-3x mb-3 text-warning"></i>
                <h3 class="text-white">النجوم</h3>
                <h2 class="text-white fw-bold">{{ total_stars }}</h2>
                <p class="text-white">من {{ total_possible_stars }} نجمة</p>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-warning" style="width: {{ stars_progress }}%;">
                        {{ stars_progress|floatformat:1 }}%
                    </div>
                </div>
                <small class="text-white mt-2">متبقي: {{ remaining_stars }} نجمة</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card glass-card p-4 text-center">
                <i class="fas fa-calendar fa-3x mb-3 text-info"></i>
                <h3 class="text-white">الأيام المدروسة</h3>
                <h2 class="text-white fw-bold">{{ studied_days_count }}</h2>
                <p class="text-white">من {{ total_possible_days }} يوم</p>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-info" style="width: {{ days_progress }}%;">
                        {{ days_progress|floatformat:1 }}%
                    </div>
                </div>
                <small class="text-white mt-2">متبقي: {{ remaining_days }} يوم</small>
            </div>
        </div>
    </div>

    <!-- Modal لعرض التفاصيل -->
    <div class="modal fade" id="contentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalContent"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // عرض التفاصيل في Modal
    window.openModal = function(content, title, type) {
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        modalTitle.textContent = title;
        if (type === 'image') {
            modalContent.innerHTML = `<img src="${content}" class="img-fluid" style="max-width: 100%;">`;
        } else {
            const escapedContent = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            modalContent.innerHTML = `<pre><code class="language-${type === 'كود' ? 'python' : 'markup'}">${escapedContent}</code></pre>`;
            Prism.highlightAll();
        }
        new bootstrap.Modal(document.getElementById('contentModal')).show();
    };

    // الرسم البياني (Radar)
    const ctx = document.getElementById('progressChart').getContext('2d');
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: [{% for month in monthly_data %}'{{ month.name }}',{% endfor %}],
            datasets: [
                {
                    label: 'ساعات السايبر',
                    data: [{% for month in monthly_data %}{{ month.cyber_hours }},{% endfor %}],
                    backgroundColor: 'rgba(0, 191, 255, 0.3)',
                    borderColor: 'rgba(0, 191, 255, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: [{% for month in monthly_data %}{% if month.days > 0 %}'rgba(0, 191, 255, 1)'{% else %}'rgba(255, 99, 71, 1)'{% endif %},{% endfor %}],
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(0, 191, 255, 1)'
                },
                {
                    label: 'ساعات الإنجليزي',
                    data: [{% for month in monthly_data %}{{ month.english_hours }},{% endfor %}],
                    backgroundColor: 'rgba(0, 255, 204, 0.3)',
                    borderColor: 'rgba(0, 255, 204, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: [{% for month in monthly_data %}{% if month.days > 0 %}'rgba(0, 255, 204, 1)'{% else %}'rgba(255, 99, 71, 1)'{% endif %},{% endfor %}],
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(0, 255, 204, 1)'
                },
                {
                    label: 'إجمالي الساعات',
                    data: [{% for month in monthly_data %}{{ month.cyber_hours|add:month.english_hours }},{% endfor %}],
                    backgroundColor: 'rgba(147, 112, 219, 0.3)',
                    borderColor: 'rgba(147, 112, 219, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: [{% for month in monthly_data %}{% if month.days > 0 %}'rgba(147, 112, 219, 1)'{% else %}'rgba(255, 99, 71, 1)'{% endif %},{% endfor %}],
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(147, 112, 219, 1)'
                },
                {
                    label: 'النجوم',
                    data: [{% for month in monthly_data %}{{ month.stars }},{% endfor %}],
                    backgroundColor: 'rgba(255, 105, 180, 0.3)',
                    borderColor: 'rgba(255, 105, 180, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: [{% for month in monthly_data %}{% if month.days > 0 %}'rgba(255, 105, 180, 1)'{% else %}'rgba(255, 99, 71, 1)'{% endif %},{% endfor %}],
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(255, 105, 180, 1)'
                },
                {
                    label: 'الأيام المدروسة',
                    data: [{% for month in monthly_data %}{{ month.days }},{% endfor %}],
                    backgroundColor: 'rgba(255, 20, 147, 0.3)',
                    borderColor: 'rgba(255, 20, 147, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: [{% for month in monthly_data %}{% if month.days > 0 %}'rgba(255, 20, 147, 1)'{% else %}'rgba(255, 99, 71, 1)'{% endif %},{% endfor %}],
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(255, 20, 147, 1)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        lineWidth: 1
                    },
                    angleLines: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        display: false
                    },
                    pointLabels: {
                        color: '#fff',
                        font: { size: 18, weight: 'bold' } // زيادة حجم النصوص
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#fff',
                        font: { size: 18 } // زيادة حجم الأساطير
                    }
                },
                title: {
                    display: true,
                    text: 'تقدم الساعات، النجوم، والأيام حسب الشهر',
                    color: '#fff',
                    font: { size: 24, weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            let value = context.parsed.r;
                            if (label.includes('ساعات')) {
                                return `${label}: ${value} ساعة`;
                            } else if (label === 'النجوم') {
                                return `${label}: ${value} نجمة`;
                            } else {
                                return `${label}: ${value} يوم`;
                            }
                        }
                    },
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff'
                }
            }
        }
    });

    // إضافة تأثير الجسيمات
    particlesJS('particleCanvas', {
        particles: {
            number: { value: 80, density: { enable: true, value_area: 800 } },
            color: { value: '#00ffcc' },
            shape: { type: 'circle' },
            opacity: { value: 0.5, random: true },
            size: { value: 3, random: true },
            line_linked: { enable: false },
            move: { enable: true, speed: 2, direction: 'none', random: true }
        },
        interactivity: {
            detect_on: 'canvas',
            events: { onhover: { enable: true, mode: 'repulse' } },
            modes: { repulse: { distance: 100, duration: 0.4 } }
        }
    });
});
</script>
{% endblock %}